name: ğŸš€ Build and Release ChzzkStreamDeck

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

# GitHub Actions ê¶Œí•œ ì„¤ì •
permissions:
  contents: write  # ë¦´ë¦¬ìŠ¤ ìƒì„±ì„ ìœ„í•œ ì“°ê¸° ê¶Œí•œ
  packages: write  # íŒ¨í‚¤ì§€ ì—…ë¡œë“œ ê¶Œí•œ
  actions: read    # ì•¡ì…˜ ì½ê¸° ê¶Œí•œ

env:
  PYTHON_VERSION: '3.13.3'
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1

jobs:
  # ë²„ì „ ê´€ë¦¬
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“‹ ë²„ì „ ê³„ì‚°
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # íƒœê·¸ê°€ ìˆìœ¼ë©´ íƒœê·¸ ë²„ì „ ì‚¬ìš©
            VERSION=${GITHUB_REF#refs/tags/}
            IS_RELEASE=true
          else
            # íƒœê·¸ê°€ ì—†ìœ¼ë©´ ì»¤ë°‹ í•´ì‹œë¡œ pre-release ë²„ì „ ìƒì„±
            SHORT_SHA=${GITHUB_SHA::7}
            COMMIT_COUNT=$(git rev-list --count HEAD)
            VERSION="v0.1.${COMMIT_COUNT}-${SHORT_SHA}"
            IS_RELEASE=false
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
          echo "ğŸ“ ë²„ì „: $VERSION (Release: $IS_RELEASE)"

  # Windows ë¹Œë“œ
  build-windows:
    needs: version
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          # webview ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª…ì‹œì  ì„¤ì¹˜ í™•ì¸
          pip show pywebview || pip install pywebview
      
      - name: ğŸ”§ ë¹Œë“œ ì„¤ì • ìƒì„± (ìë™)
        run: |
          python -c "
          from build_config import BuildConfig
          import json
          
          # ê¸°ë³¸ í¬íŠ¸ë¡œ ìë™ ì„¤ì •
          config = BuildConfig()
          config.config['server']['port'] = 8080
          config.config['modules']['spotify']['redirect_uri'] = 'http://localhost:8080/spotify/callback'
          
          with open('config_build.json', 'w', encoding='utf-8') as f:
              json.dump(config.config, f, indent=2, ensure_ascii=False)
          
          print('Build config generated successfully')
          "
      
      - name: ğŸ”¨ Windows ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ
        run: |
          # ë°”ì´ëŸ¬ìŠ¤ ì˜¤íƒ ë°©ì§€ë¥¼ ìœ„í•œ ìµœì í™”ëœ ë¹Œë“œ
          $pyinstaller_args = @(
            "--clean",
            "--noconfirm", 
            "--onedir",
            "run_chzzk.py",
            "--name", "ChzzkStreamDeck",
            "--distpath", "dist-windows",
            "--workpath", "build-windows",
            "--add-data", "neon;neon",
            "--add-data", "purple;purple", 
            "--add-data", "main;main",
            "--add-data", "requirements.txt;.",
            "--add-data", "config_build.json;.",
            "--add-data", "README.md;.",
            "--add-data", "check_system.py;.",
            "--noupx",
            "--strip",
            "--log-level=WARN",
            "--console",
            "--hidden-import", "websockets",
            "--hidden-import", "websockets.legacy",
            "--hidden-import", "websockets.legacy.server",
            "--hidden-import", "aiohttp",
            "--hidden-import", "aiohttp.web",
            "--hidden-import", "aiohttp.client",
            "--hidden-import", "requests",
            "--hidden-import", "urllib3",
            "--hidden-import", "certifi",
            "--hidden-import", "pywebview",
            "--hidden-import", "pywebview.platforms",
            "--hidden-import", "pywebview.platforms.winforms",
            "--hidden-import", "pywebview.platforms.cef",
            "--hidden-import", "psutil",
            "--hidden-import", "http.server",
            "--hidden-import", "http.client",
            "--hidden-import", "socketserver",
            "--hidden-import", "urllib.parse",
            "--hidden-import", "json",
            "--hidden-import", "webbrowser",
            "--hidden-import", "threading",
            "--hidden-import", "logging",
            "--hidden-import", "asyncio",
            "--hidden-import", "traceback",
            "--hidden-import", "argparse",
            "--hidden-import", "time",
            "--hidden-import", "signal",
            "--hidden-import", "atexit",
            "--exclude-module", "matplotlib",
            "--exclude-module", "numpy",
            "--exclude-module", "pandas",
            "--exclude-module", "scipy",
            "--exclude-module", "tkinter",
            "--exclude-module", "PIL",
            "--exclude-module", "cv2"
          )
          
          Write-Output "ğŸ”¨ PyInstaller ì‹¤í–‰ ì¤‘..."
          & pyinstaller @pyinstaller_args
          
          if ($LASTEXITCODE -eq 0) {
            Write-Output "âœ… ë¹Œë“œ ì„±ê³µ!"
          } else {
            Write-Output "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
            exit 1
          }
      
      - name: ğŸ“¦ Windows ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ìƒì„±
        run: |
          mkdir release-windows
          
          # Copy all files from build directory using PowerShell
          Copy-Item -Path "dist-windows\ChzzkStreamDeck\*" -Destination "release-windows" -Recurse -Force
          
          # Copy additional files
          if (Test-Path "config_build.json") { Copy-Item "config_build.json" "release-windows\" }
          if (Test-Path "README.md") { Copy-Item "README.md" "release-windows\" }
          if (Test-Path "check_system.py") { Copy-Item "check_system.py" "release-windows\" }
          
          Write-Output "âœ… Windows release package created successfully"
          
          @"
          # ChzzkStreamDeck Windows Usage Guide
          
          ## How to Run
          1. Extract the zip file to a folder
          2. Double-click ChzzkStreamDeck.exe in the extracted folder
          3. If Windows Defender warns, click More info -> Run anyway
          4. Admin panel will open automatically in your browser
          
          ## Important Notes
          - Keep ALL files in the same folder (do not move ChzzkStreamDeck.exe alone)
          - The app includes all dependencies - no Python installation required
          - First startup may take 10-15 seconds (creating necessary files)
          
          ## System Requirements
          - Windows 10/11 (64-bit)
          - 4GB RAM minimum, 8GB recommended
          - Internet connection for Spotify/Chzzk features
          - 500MB free disk space
          
          ## Troubleshooting
          - If app doesn't start: Run as administrator
          - If Windows Defender blocks: Add folder to exclusions
          - If port conflict: Use --port 8081 argument
          - If slow startup: Be patient on first run (normal behavior)
          "@ | Out-File -FilePath "release-windows\USER_GUIDE.md" -Encoding UTF8
          
          @"
          # âš ï¸ ë°”ì´ëŸ¬ìŠ¤ ì˜¤íƒ(False Positive) ì•ˆë‚´
          
          ## ğŸ” Trojan:Win32/Sabsik.TE.A!ml ì˜¤íƒ ê´€ë ¨
          
          ì´ í”„ë¡œê·¸ë¨ì´ ë°”ì´ëŸ¬ìŠ¤ë¡œ ê°ì§€ë˜ëŠ” ê²ƒì€ **Windows Defenderì˜ ì˜¤íƒ(False Positive)**ì…ë‹ˆë‹¤.
          
          ### ì˜¤íƒì´ ë°œìƒí•˜ëŠ” ì´ìœ :
          1. **PyInstallerë¡œ ë¹Œë“œëœ Python ì‹¤í–‰ íŒŒì¼** - íŒ¨í‚¹ëœ êµ¬ì¡°ê°€ ì˜ì‹¬ìŠ¤ëŸ½ê²Œ ë³´ì„
          2. **ë„¤íŠ¸ì›Œí¬ í†µì‹  ê¸°ëŠ¥** - ì¹˜ì§€ì§/Spotify API ì—°ë™
          3. **í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬ ê¸°ëŠ¥** - ì•ˆì „í•œ ì•± ì¢…ë£Œë¥¼ ìœ„í•œ ê¸°ëŠ¥
          4. **ì„œëª…ë˜ì§€ ì•Šì€ ì‹¤í–‰ íŒŒì¼** - ê°œì¸ í”„ë¡œì íŠ¸ë¡œ ì½”ë“œ ì‚¬ì´ë‹ ì—†ìŒ
          
          ### ì•ˆì „ì„± í™•ì¸ ë°©ë²•:
          1. **VirusTotal ê²€ì‚¬**: ì´ íŒŒì¼ì„ VirusTotal.comì— ì—…ë¡œë“œí•˜ì—¬ í™•ì¸
          2. **ì†ŒìŠ¤ ì½”ë“œ ê³µê°œ**: GitHubì—ì„œ ì „ì²´ ì†ŒìŠ¤ ì½”ë“œ í™•ì¸ ê°€ëŠ¥
          3. **ì»¤ë®¤ë‹ˆí‹° ê²€ì¦**: ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì˜ ì‚¬ìš© í›„ê¸° í™•ì¸
          
          ### ì‚¬ìš©í•˜ë ¤ë©´:
          1. **Windows Defender ì˜ˆì™¸ ì¶”ê°€**:
             - Windows ë³´ì•ˆ â†’ ë°”ì´ëŸ¬ìŠ¤ ë° ìœ„í˜‘ ë°©ì§€ â†’ ì„¤ì • ê´€ë¦¬
             - ë°”ì´ëŸ¬ìŠ¤ ë° ìœ„í˜‘ ë°©ì§€ ì„¤ì •ì—ì„œ 'ì˜ˆì™¸ ì¶”ê°€'
             - ì´ í´ë”ë¥¼ ì˜ˆì™¸ë¡œ ì¶”ê°€
          
          2. **ì‹¤í–‰ ì‹œ ê²½ê³  ë¬´ì‹œ**:
             - "Windowsì˜ PC ë³´í˜¸" ê²½ê³ ì—ì„œ "ì¶”ê°€ ì •ë³´" í´ë¦­
             - "ì‹¤í–‰" ë²„íŠ¼ í´ë¦­
          
          ### ì—¬ì „íˆ ê±±ì •ëœë‹¤ë©´:
          - Python í™˜ê²½ì—ì„œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì§ì ‘ ì‹¤í–‰í•˜ì„¸ìš”
          - GitHubì—ì„œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ê²€í† í•˜ì„¸ìš”
          - ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì½”ë“œê°€ ìˆë‹¤ë©´ ì´ìŠˆë¡œ ì‹ ê³ í•´ì£¼ì„¸ìš”
          
          ### ì—°ë½ì²˜:
          - GitHub Issues: [í”„ë¡œì íŠ¸ í˜ì´ì§€]
          - ì†ŒìŠ¤ ì½”ë“œ: 100% ê³µê°œ
          - ë¼ì´ì„ ìŠ¤: MIT (ììœ  ì‚¬ìš©)
          
          ì´ í”„ë¡œê·¸ë¨ì€ ìŠ¤íŠ¸ë¦¬ë° ë„êµ¬ì¼ ë¿ì´ë©°, ì•…ì„± ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.
          "@ | Out-File -FilePath "release-windows\VIRUS_FALSE_POSITIVE.md" -Encoding UTF8
      
      - name: ğŸ“¤ Windows ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ChzzkStreamDeck-Windows-${{ needs.version.outputs.version }}
          path: release-windows/

  # Linux ë¹Œë“œ
  build-linux:
    needs: version
    runs-on: ubuntu-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          # webview ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª…ì‹œì  ì„¤ì¹˜ í™•ì¸
          pip show pywebview || pip install pywebview
      
      - name: ğŸ”§ ë¹Œë“œ ì„¤ì • ìƒì„± (ìë™)
        run: |
          python3 -c "
          from build_config import BuildConfig
          import json
          
          config = BuildConfig()
          config.config['server']['port'] = 8080
          config.config['modules']['spotify']['redirect_uri'] = 'http://localhost:8080/spotify/callback'
          
          with open('config_build.json', 'w', encoding='utf-8') as f:
              json.dump(config.config, f, indent=2, ensure_ascii=False)
          
          print('Build config generated successfully')
          "
      
      - name: ğŸ”¨ Linux ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ
        run: |
          pyinstaller --clean --noconfirm --onedir main.py --name ChzzkStreamDeck \
            --distpath dist-linux \
            --workpath build-linux \
            --add-data "neon:neon" \
            --add-data "purple:purple" \
            --add-data "main:main" \
            --add-data "requirements.txt:." \
            --add-data "config_build.json:." \
            --add-data "README.md:." \
            --add-data "check_system.py:." \
            --hidden-import websockets \
            --hidden-import websockets.legacy \
            --hidden-import websockets.legacy.server \
            --hidden-import aiohttp \
            --hidden-import aiohttp.web \
            --hidden-import aiohttp.client \
            --hidden-import requests \
            --hidden-import requests.adapters \
            --hidden-import requests.auth \
            --hidden-import urllib3 \
            --hidden-import certifi \
            --hidden-import pywebview \
            --hidden-import pywebview.platforms \
            --hidden-import pywebview.platforms.gtk \
            --hidden-import pywebview.platforms.qt \
            --hidden-import psutil \
            --hidden-import http.server \
            --hidden-import http.client \
            --hidden-import http.cookies \
            --hidden-import http.cookiejar \
            --hidden-import socketserver \
            --hidden-import urllib.parse \
            --hidden-import urllib.request \
            --hidden-import urllib.error \
            --hidden-import json \
            --hidden-import webbrowser \
            --hidden-import base64 \
            --hidden-import platform \
            --hidden-import subprocess \
            --hidden-import signal \
            --hidden-import atexit \
            --hidden-import importlib \
            --hidden-import importlib.util \
            --hidden-import datetime \
            --hidden-import threading \
            --hidden-import time \
            --hidden-import logging \
            --hidden-import logging.handlers \
            --hidden-import asyncio \
            --hidden-import asyncio.events \
            --hidden-import asyncio.queues \
            --hidden-import pathlib \
            --hidden-import typing \
            --hidden-import ssl \
            --hidden-import socket \
            --hidden-import select \
            --hidden-import email \
            --hidden-import email.mime \
            --hidden-import email.mime.text \
            --hidden-import hashlib \
            --hidden-import hmac \
            --hidden-import secrets \
            --hidden-import uuid \
            --hidden-import mimetypes \
            --hidden-import shutil \
            --hidden-import tempfile \
            --hidden-import glob \
            --hidden-import fnmatch \
            --hidden-import re \
            --hidden-import string \
            --hidden-import collections \
            --hidden-import collections.abc \
            --hidden-import queue \
            --hidden-import io \
            --hidden-import codecs \
            --hidden-import encodings \
            --hidden-import encodings.utf_8 \
            --collect-all websockets \
            --collect-all aiohttp \
            --collect-all http \
            --collect-all urllib \
            --collect-all datetime \
            --collect-all asyncio \
            --collect-all logging \
            --collect-all email \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module pandas \
            --exclude-module scipy \
            --exclude-module tkinter \
            --exclude-module PIL \
            --exclude-module cv2 \
            --exclude-module torch \
            --exclude-module tensorflow \
            --exclude-module IPython \
            --exclude-module jupyter
      
      - name: ğŸ“¦ Linux ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ìƒì„±
        run: |
          mkdir release-linux
          cp -r dist-linux/ChzzkStreamDeck/* release-linux/
          cp config_build.json release-linux/ || echo "config_build.json not found"
          cp README.md release-linux/ || echo "README.md not found"
          cp check_system.py release-linux/ || echo "check_system.py not found"
          chmod +x release-linux/ChzzkStreamDeck
          
          # ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > release-linux/run.sh << 'EOF'
          #!/bin/bash
          echo "ChzzkStreamDeck starting..."
          ./ChzzkStreamDeck
          EOF
          chmod +x release-linux/run.sh
      
      - name: ğŸ“¤ Linux ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ChzzkStreamDeck-Linux-${{ needs.version.outputs.version }}
          path: release-linux/

  # ë¦´ë¦¬ìŠ¤ ìƒì„±
  release:
    needs: [version, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“¥ ëª¨ë“  ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
      
      - name: ğŸ“¦ ë¦´ë¦¬ìŠ¤ ì••ì¶• íŒŒì¼ ìƒì„±
        run: |
          # Windows ë¦´ë¦¬ìŠ¤
          cd "ChzzkStreamDeck-Windows-${{ needs.version.outputs.version }}"
          zip -r "../ChzzkStreamDeck-Windows-${{ needs.version.outputs.version }}.zip" .
          cd ..
          
          # Linux ë¦´ë¦¬ìŠ¤
          cd "ChzzkStreamDeck-Linux-${{ needs.version.outputs.version }}"
          tar -czf "../ChzzkStreamDeck-Linux-${{ needs.version.outputs.version }}.tar.gz" .
          cd ..
      
      - name: ğŸ·ï¸ GitHub ë¦´ë¦¬ìŠ¤ ìƒì„±
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.version }}
          name: "ChzzkStreamDeck ${{ needs.version.outputs.version }}"
          body: |
            # ğŸ® ChzzkStreamDeck ${{ needs.version.outputs.version }}
            
            ## ğŸ†• ìƒˆë¡œìš´ ê¸°ëŠ¥
            - ì¹˜ì§€ì§ ì±„íŒ… ì˜¤ë²„ë ˆì´
            - Spotify ìŒì•… ì •ë³´ ì˜¤ë²„ë ˆì´  
            - ë„¤ì˜¨/í¼í”Œ í…Œë§ˆ ì§€ì›
            - í¬íŠ¸ ì„ íƒ ê°€ëŠ¥
            - ì™„ì „í•œ ì¢…ë£Œ ì‹œìŠ¤í…œ
            
            ## ğŸ“¦ ë‹¤ìš´ë¡œë“œ
            - **Windows**: ChzzkStreamDeck-Windows-${{ needs.version.outputs.version }}.zip
            - **Linux**: ChzzkStreamDeck-Linux-${{ needs.version.outputs.version }}.tar.gz
            
            ## ğŸ”§ ì„¤ì¹˜ ë° ì‚¬ìš©ë²•
            1. í•´ë‹¹ OSìš© íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            2. ì••ì¶• í•´ì œ
            3. ì‹¤í–‰ íŒŒì¼ ì‹¤í–‰
            4. ê´€ë¦¬íŒ¨ë„ì—ì„œ ì„¤ì • ì…ë ¥
            
            ## âš ï¸ ì£¼ì˜ì‚¬í•­
            - ì²« ì‹¤í–‰ ì‹œ ë°©í™”ë²½/ë³´ì•ˆ í”„ë¡œê·¸ë¨ì—ì„œ í—ˆìš© í•„ìš”
            - Spotify ì‚¬ìš© ì‹œ ê°œë°œì ì•± ë“±ë¡ í•„ìš”
            
            ---
            **ë¹Œë“œ ì •ë³´**: ${{ github.sha }}
          draft: ${{ needs.version.outputs.is_release == 'false' }}
          prerelease: ${{ needs.version.outputs.is_release == 'false' }}
          make_latest: ${{ needs.version.outputs.is_release == 'true' }}
          generate_release_notes: true
          files: |
            ChzzkStreamDeck-Windows-${{ needs.version.outputs.version }}.zip
            ChzzkStreamDeck-Linux-${{ needs.version.outputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
name: ğŸš€ Build and Release ChzzkStreamDeck

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.13.3'

jobs:
  # ë²„ì „ ê´€ë¦¬
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“‹ ë²„ì „ ê³„ì‚°
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # íƒœê·¸ê°€ ìˆìœ¼ë©´ íƒœê·¸ ë²„ì „ ì‚¬ìš©
            VERSION=${GITHUB_REF#refs/tags/}
            IS_RELEASE=true
          else
            # íƒœê·¸ê°€ ì—†ìœ¼ë©´ ì»¤ë°‹ í•´ì‹œë¡œ pre-release ë²„ì „ ìƒì„±
            SHORT_SHA=${GITHUB_SHA::7}
            COMMIT_COUNT=$(git rev-list --count HEAD)
            VERSION="v0.1.${COMMIT_COUNT}-${SHORT_SHA}"
            IS_RELEASE=false
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
          echo "ğŸ“ ë²„ì „: $VERSION (Release: $IS_RELEASE)"

  # Windows ë¹Œë“œ
  build-windows:
    needs: version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: ğŸ”§ ë¹Œë“œ ì„¤ì • ìƒì„± (ìë™)
        run: |
          python -c "
          from build_config import BuildConfig
          import json
          
          # ê¸°ë³¸ í¬íŠ¸ë¡œ ìë™ ì„¤ì •
          config = BuildConfig()
          config.config['server']['port'] = 8080
          config.config['modules']['spotify']['redirect_uri'] = 'http://localhost:8080/spotify/callback'
          
          with open('config_build.json', 'w', encoding='utf-8') as f:
              json.dump(config.config, f, indent=2, ensure_ascii=False)
          
          print('âœ… ë¹Œë“œ ì„¤ì • ìë™ ìƒì„± ì™„ë£Œ')
          "
      
      - name: ğŸ”¨ Windows ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ
        run: |
          pyinstaller --clean --noconfirm --onefile main.py --name ChzzkStreamDeck --add-data "neon;neon" --add-data "purple;purple" --add-data "main;main" --add-data "requirements.txt;." --add-data "config_build.json;." --add-data "README.md;." --hidden-import websockets --hidden-import aiohttp --hidden-import requests --hidden-import pywebview --hidden-import psutil
      
      - name: ğŸ“¦ Windows ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ìƒì„±
        run: |
          mkdir release-windows
          copy dist\ChzzkStreamDeck.exe release-windows\
          copy config_build.json release-windows\ 2>nul || echo "config_build.json not found"
          copy README.md release-windows\ 2>nul || echo "README.md not found"
          
          echo # ChzzkStreamDeck Windows ì‚¬ìš© ê°€ì´ë“œ > release-windows\USER_GUIDE.md
          echo. >> release-windows\USER_GUIDE.md
          echo ## ğŸ® ì‹¤í–‰ ë°©ë²• >> release-windows\USER_GUIDE.md
          echo 1. ChzzkStreamDeck.exe ë”ë¸”í´ë¦­ >> release-windows\USER_GUIDE.md
          echo 2. Windows Defender ê²½ê³  ì‹œ ì¶”ê°€ ì •ë³´ -^> ì‹¤í–‰ í´ë¦­ >> release-windows\USER_GUIDE.md
          echo 3. ê´€ë¦¬íŒ¨ë„ì—ì„œ ì„¤ì • ì…ë ¥ >> release-windows\USER_GUIDE.md
      
      - name: ğŸ“¤ Windows ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: ChzzkStreamDeck-Windows-${{ needs.version.outputs.version }}
          path: release-windows/

  # Linux ë¹Œë“œ
  build-linux:
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: ğŸ”§ ë¹Œë“œ ì„¤ì • ìƒì„± (ìë™)
        run: |
          python3 -c "
          from build_config import BuildConfig
          import json
          
          config = BuildConfig()
          config.config['server']['port'] = 8080
          config.config['modules']['spotify']['redirect_uri'] = 'http://localhost:8080/spotify/callback'
          
          with open('config_build.json', 'w', encoding='utf-8') as f:
              json.dump(config.config, f, indent=2, ensure_ascii=False)
          
          print('âœ… ë¹Œë“œ ì„¤ì • ìë™ ìƒì„± ì™„ë£Œ')
          "
      
      - name: ğŸ”¨ Linux ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ
        run: |
          pyinstaller --clean --noconfirm --onefile main.py --name ChzzkStreamDeck \
            --add-data "neon:neon" \
            --add-data "purple:purple" \
            --add-data "main:main" \
            --add-data "requirements.txt:." \
            --add-data "config_build.json:." \
            --add-data "README.md:." \
            --hidden-import websockets \
            --hidden-import aiohttp \
            --hidden-import requests \
            --hidden-import pywebview \
            --hidden-import psutil
      
      - name: ğŸ“¦ Linux ë¦´ë¦¬ìŠ¤ íŒ¨í‚¤ì§€ ìƒì„±
        run: |
          mkdir release-linux
          cp dist/ChzzkStreamDeck release-linux/
          cp config_build.json release-linux/ || echo "config_build.json not found"
          cp README.md release-linux/ || echo "README.md not found"
          chmod +x release-linux/ChzzkStreamDeck
          
          # ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > release-linux/run.sh << 'EOF'
          #!/bin/bash
          echo "ğŸ® ChzzkStreamDeck ì‹¤í–‰ ì¤‘..."
          ./ChzzkStreamDeck
          EOF
          chmod +x release-linux/run.sh
      
      - name: ğŸ“¤ Linux ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: ChzzkStreamDeck-Linux-${{ needs.version.outputs.version }}
          path: release-linux/

  # ë¦´ë¦¬ìŠ¤ ìƒì„±
  release:
    needs: [version, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“¥ ëª¨ë“  ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
      
      - name: ğŸ“¦ ë¦´ë¦¬ìŠ¤ ì••ì¶• íŒŒì¼ ìƒì„±
        run: |
          # Windows ë¦´ë¦¬ìŠ¤
          cd "ChzzkStreamDeck-Windows-${{ needs.version.outputs.version }}"
          zip -r "../ChzzkStreamDeck-Windows-${{ needs.version.outputs.version }}.zip" .
          cd ..
          
          # Linux ë¦´ë¦¬ìŠ¤
          cd "ChzzkStreamDeck-Linux-${{ needs.version.outputs.version }}"
          tar -czf "../ChzzkStreamDeck-Linux-${{ needs.version.outputs.version }}.tar.gz" .
          cd ..
      
      - name: ğŸ·ï¸ GitHub ë¦´ë¦¬ìŠ¤ ìƒì„±
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version.outputs.version }}
          name: "ChzzkStreamDeck ${{ needs.version.outputs.version }}"
          body: |
            # ğŸ® ChzzkStreamDeck ${{ needs.version.outputs.version }}
            
            ## ğŸ†• ìƒˆë¡œìš´ ê¸°ëŠ¥
            - ì¹˜ì§€ì§ ì±„íŒ… ì˜¤ë²„ë ˆì´
            - Spotify ìŒì•… ì •ë³´ ì˜¤ë²„ë ˆì´  
            - ë„¤ì˜¨/í¼í”Œ í…Œë§ˆ ì§€ì›
            - í¬íŠ¸ ì„ íƒ ê°€ëŠ¥
            - ì™„ì „í•œ ì¢…ë£Œ ì‹œìŠ¤í…œ
            
            ## ğŸ“¦ ë‹¤ìš´ë¡œë“œ
            - **Windows**: ChzzkStreamDeck-Windows-${{ needs.version.outputs.version }}.zip
            - **Linux**: ChzzkStreamDeck-Linux-${{ needs.version.outputs.version }}.tar.gz
            
            ## ğŸ”§ ì„¤ì¹˜ ë° ì‚¬ìš©ë²•
            1. í•´ë‹¹ OSìš© íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            2. ì••ì¶• í•´ì œ
            3. ì‹¤í–‰ íŒŒì¼ ì‹¤í–‰
            4. ê´€ë¦¬íŒ¨ë„ì—ì„œ ì„¤ì • ì…ë ¥
            
            ## âš ï¸ ì£¼ì˜ì‚¬í•­
            - ì²« ì‹¤í–‰ ì‹œ ë°©í™”ë²½/ë³´ì•ˆ í”„ë¡œê·¸ë¨ì—ì„œ í—ˆìš© í•„ìš”
            - Spotify ì‚¬ìš© ì‹œ ê°œë°œì ì•± ë“±ë¡ í•„ìš”
            
            ---
            **ë¹Œë“œ ì •ë³´**: ${{ github.sha }}
          draft: ${{ needs.version.outputs.is_release == 'false' }}
          prerelease: ${{ needs.version.outputs.is_release == 'false' }}
          files: |
            ChzzkStreamDeck-Windows-${{ needs.version.outputs.version }}.zip
            ChzzkStreamDeck-Linux-${{ needs.version.outputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
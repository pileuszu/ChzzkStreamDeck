<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify ÏúÑÏ†Ø</title>
    <style>
        /* ===== FONT IMPORT ===== */
        @font-face {
            font-family: 'Ownglyph_ParkDaHyun';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2411-3@1.0/Ownglyph_ParkDaHyun.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        /* ===== BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Ownglyph_ParkDaHyun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            overflow: hidden;
            padding: 20px;
        }

        /* ===== SPOTIFY WIDGET - SIMPLE PURPLE THEME ===== */
        .spotify-widget {
            background: #ffffff;
            border: 2px solid rgba(147, 112, 219, 0.8);
            border-radius: 15px;
            padding: 20px;
            width: fit-content;
            max-width: 400px;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: visible;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .spotify-widget:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(147, 112, 219, 0.2);
        }



        /* Ïï®Î≤î Ïª§Î≤Ñ */
        .album-cover {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            background: linear-gradient(135deg, #8a2be2 0%, #9370db 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            box-shadow: 0 2px 8px rgba(138, 43, 226, 0.3);
            flex-shrink: 0;
        }

        .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .album-cover.playing {
            animation: pulse 2s infinite;
        }

        /* Í≥° Ï†ïÎ≥¥ */
        .song-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .song-title {
            font-size: 18px;
            font-weight: 800;
            color: #8a2be2;
            line-height: 1.2;
            margin: 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .song-artist {
            font-size: 14px;
            color: #666;
            font-weight: 500;
            line-height: 1.3;
            margin: 0;
        }

        /* Ïû¨ÏÉùÎ∞î */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 4px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(138, 43, 226, 0.2);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #8a2be2 0%, #9370db 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .time {
            font-size: 12px;
            color: #999;
            min-width: 35px;
            font-weight: 500;
            text-align: center;
        }

        /* ÏÉÅÌÉú ÌëúÏãú */
        .no-track, .loading, .error {
            text-align: center;
            padding: 40px 20px;
            color: #8a2be2;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
        }

        .error {
            color: #e74c3c;
        }

        .connect-button {
            margin-top: 12px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #8a2be2 0%, #9370db 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Ownglyph_ParkDaHyun', sans-serif;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(138, 43, 226, 0.3);
        }

        .connect-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(138, 43, 226, 0.4);
        }

        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
                filter: blur(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
                filter: blur(0);
            }
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 2px 8px rgba(138, 43, 226, 0.3);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 4px 12px rgba(138, 43, 226, 0.5);
            }
        }

        .spotify-widget {
            animation: slideIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 450px) {
            .spotify-widget {
                flex-direction: column;
                text-align: center;
                gap: 16px;
                min-width: 250px;
            }
            
            .album-cover {
                width: 60px;
                height: 60px;
            }
            
            .song-title {
                font-size: 16px;
            }
            
            .song-artist {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="spotify-widget" id="spotifyWidget">
        <div class="loading">
            <div>üéµ Spotify Ïó∞Í≤∞ Ï§ë...</div>
        </div>
    </div>

    <script>
        class SpotifyWidget {
            constructor() {
                this.widget = document.getElementById('spotifyWidget');
                this.serverUrl = 'http://localhost:7112';
                this.isConnected = false;
                this.currentTrack = null;
                this.accessToken = null;
                this.refreshToken = null;
                this.tokenExpiry = null;
                this.pollingInterval = null;
                this.progressInterval = null;
                
                // Spotify API ÏÑ§Ï†ï
                this.clientId = null;
                this.clientSecret = null;
                this.redirectUri = `http://localhost:7112/spotify/callback`;
                this.scopes = [
                    'user-read-currently-playing',
                    'user-read-playback-state'
                ].join(' ');
                
                this.init();
            }

            init() {
                this.loadSettings();
                this.checkAuthStatus();
                this.setupEventListeners();
                
                console.log('üéµ Spotify ÏúÑÏ†Ø ÏãúÏûë');
            }

            loadSettings() {
                // Ïä§Ìè¨Ìã∞ÌååÏù¥ Ïù∏Ï¶ù Ï†ïÎ≥¥ Î°úÎìú
                this.clientId = localStorage.getItem('spotify-client-id');
                this.clientSecret = localStorage.getItem('spotify-client-secret');
                this.accessToken = localStorage.getItem('spotify-access-token');
                this.refreshToken = localStorage.getItem('spotify-refresh-token');
                this.tokenExpiry = localStorage.getItem('spotify-token-expiry');
            }

            setupEventListeners() {
                // ÏÑ§Ï†ï Î≥ÄÍ≤Ω Í∞êÏßÄ
                window.addEventListener('storage', (e) => {
                    if (e.key && e.key.startsWith('spotify-')) {
                        this.loadSettings();
                        this.checkAuthStatus();
                    }
                });

                // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
                window.addEventListener('beforeunload', () => {
                    this.disconnect();
                });
            }

            async checkAuthStatus() {
                if (!this.clientId || !this.clientSecret) {
                    this.showError('Spotify Client ID/SecretÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.<br>Î©îÏù∏ ÎåÄÏãúÎ≥¥Îìú ÏÑ§Ï†ïÏóêÏÑú Ïù∏Ï¶ùÏùÑ ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                // Í∏∞Ï°¥ ÌÜ†ÌÅ∞ ÌôïÏù∏
                if (this.accessToken) {
                    if (this.isTokenExpired()) {
                        console.log('üîÑ ÌÜ†ÌÅ∞ Í∞±Ïã† Ï§ë...');
                        await this.refreshAccessToken();
                    } else {
                        console.log('‚úÖ Ïú†Ìö®Ìïú ÌÜ†ÌÅ∞ Î∞úÍ≤¨');
                        this.startPolling();
                    }
                } else {
                    this.showAuthButton();
                }
            }

            async refreshAccessToken() {
                if (!this.refreshToken) {
                    this.showAuthButton();
                    return;
                }

                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': 'Basic ' + btoa(`${this.clientId}:${this.clientSecret}`)
                        },
                        body: new URLSearchParams({
                            grant_type: 'refresh_token',
                            refresh_token: this.refreshToken
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        this.accessToken = data.access_token;
                        this.tokenExpiry = Date.now() + (data.expires_in * 1000);
                        
                        // ÏÉà refresh tokenÏù¥ ÏûàÏúºÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
                        if (data.refresh_token) {
                            this.refreshToken = data.refresh_token;
                            localStorage.setItem('spotify-refresh-token', this.refreshToken);
                        }
                        
                        localStorage.setItem('spotify-access-token', this.accessToken);
                        localStorage.setItem('spotify-token-expiry', this.tokenExpiry);
                        
                        console.log('‚úÖ Spotify ÌÜ†ÌÅ∞ Í∞±Ïã† ÏÑ±Í≥µ');
                        this.startPolling();
                    } else {
                        throw new Error(data.error_description || 'Token refresh failed');
                    }
                } catch (error) {
                    console.error('‚ùå ÌÜ†ÌÅ∞ Í∞±Ïã† Ïã§Ìå®:', error);
                    this.clearTokens();
                    this.showAuthButton();
                }
            }

            isTokenExpired() {
                return this.tokenExpiry && Date.now() >= this.tokenExpiry;
            }

            clearTokens() {
                this.accessToken = null;
                this.refreshToken = null;
                this.tokenExpiry = null;
                localStorage.removeItem('spotify-access-token');
                localStorage.removeItem('spotify-refresh-token');
                localStorage.removeItem('spotify-token-expiry');
            }

            async getCurrentTrack() {
                if (!this.accessToken) {
                    this.showAuthButton();
                    return;
                }

                try {
                    const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`
                        }
                    });

                    if (response.status === 204) {
                        // Ïû¨ÏÉù Ï§ëÏù∏ ÏùåÏïÖ ÏóÜÏùå
                        this.showNoTrack();
                        return;
                    }

                    if (response.status === 401) {
                        // ÌÜ†ÌÅ∞ ÎßåÎ£å
                        console.log('üîÑ ÌÜ†ÌÅ∞ ÎßåÎ£å, Í∞±Ïã† Ï§ë...');
                        await this.refreshAccessToken();
                        return;
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (data.item) {
                        const track = {
                            name: data.item.name,
                            artists: data.item.artists.map(artist => artist.name),
                            album_name: data.item.album.name,
                            album_image: data.item.album.images[0]?.url,
                            duration_ms: data.item.duration_ms,
                            progress_ms: data.progress_ms,
                            is_playing: data.is_playing
                        };
                        
                        this.showTrack(track);
                    } else {
                        this.showNoTrack();
                    }
                } catch (error) {
                    console.error('‚ùå ÌòÑÏû¨ Ìä∏Îûô Ï°∞Ìöå Ïã§Ìå®:', error);
                    this.showError('API Ìò∏Ï∂ú Ïã§Ìå®: ' + error.message);
                }
            }

            startPolling() {
                this.isConnected = true;
                
                // Ï¶âÏãú Ìïú Î≤à Ìò∏Ï∂ú
                this.getCurrentTrack();
                
                // 5Ï¥àÎßàÎã§ Ìè¥ÎßÅ
                this.pollingInterval = setInterval(() => {
                    this.getCurrentTrack();
                }, 5000);
                
                console.log('üîÑ Spotify Ìè¥ÎßÅ ÏãúÏûë');
            }

            stopPolling() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                    this.pollingInterval = null;
                }
                this.isConnected = false;
                console.log('üõë Spotify Ìè¥ÎßÅ Ï§ëÏßÄ');
            }

            showAuthButton() {
                this.widget.innerHTML = `
                    <div class="no-track">
                        <div>üéµ Spotify Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§</div>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">Î©îÏù∏ ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú Ïù∏Ï¶ùÏùÑ ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî</div>
                    </div>
                `;
            }

            showTrack(track) {
                this.currentTrack = track;
                
                const progressPercent = track.duration_ms > 0 ? (track.progress_ms / track.duration_ms) * 100 : 0;
                
                this.widget.innerHTML = `
                    <div class="album-cover ${track.is_playing ? 'playing' : ''}">
                        ${track.album_image ? 
                            `<img src="${track.album_image}" alt="${track.album_name}">` : 
                            'üéµ'
                        }
                    </div>
                    <div class="song-info">
                        <div class="song-title">${this.escapeHtml(track.name)}</div>
                        <div class="song-artist">${this.escapeHtml(track.artists.join(', '))}</div>
                        <div class="progress-container">
                            <span class="time" id="current-time">${this.formatTime(track.progress_ms)}</span>
                            <div class="progress-bar">
                                <div class="progress" id="progress-bar" style="width: ${progressPercent}%"></div>
                            </div>
                            <span class="time" id="total-time">${this.formatTime(track.duration_ms)}</span>
                        </div>
                    </div>
                `;
                
                // Ïã§ÏãúÍ∞Ñ ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
                this.startProgressUpdate(track);
            }

            showNoTrack() {
                this.stopProgressUpdate();
                this.widget.innerHTML = `
                    <div class="no-track">
                        <div>üéµ Ïû¨ÏÉù Ï§ëÏù∏ ÏùåÏïÖÏù¥ ÏóÜÏäµÎãàÎã§</div>
                    </div>
                `;
            }

            showError(message) {
                this.stopProgressUpdate();
                this.widget.innerHTML = `
                    <div class="error">
                        <div>‚ùå ${message}</div>
                    </div>
                `;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatTime(ms) {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            startProgressUpdate(track) {
                // Í∏∞Ï°¥ ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏ Ï§ëÏßÄ
                if (this.progressInterval) {
                    clearInterval(this.progressInterval);
                    this.progressInterval = null;
                }
                
                // Ïû¨ÏÉù Ï§ëÏù¥ ÏïÑÎãàÎ©¥ ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏßÄ ÏïäÏùå
                if (!track.is_playing) {
                    return;
                }
                
                let currentProgress = track.progress_ms;
                const startTime = Date.now();
                
                this.progressInterval = setInterval(() => {
                    // ÌòÑÏû¨ ÏßÑÌñâÎ•† Í≥ÑÏÇ∞ (Ïã§Ï†ú ÏãúÍ∞Ñ Í≤ΩÍ≥º Î∞òÏòÅ)
                    const elapsed = Date.now() - startTime;
                    const newProgress = currentProgress + elapsed;
                    
                    // Ï¥ù ÏãúÍ∞ÑÏùÑ Ï¥àÍ≥ºÌïòÏßÄ ÏïäÎèÑÎ°ù Ï†úÌïú
                    if (newProgress >= track.duration_ms) {
                        clearInterval(this.progressInterval);
                        this.progressInterval = null;
                        return;
                    }
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    const progressPercent = (newProgress / track.duration_ms) * 100;
                    const currentTimeElement = document.getElementById('current-time');
                    const progressBarElement = document.getElementById('progress-bar');
                    
                    if (currentTimeElement) {
                        currentTimeElement.textContent = this.formatTime(newProgress);
                    }
                    
                    if (progressBarElement) {
                        progressBarElement.style.width = `${progressPercent}%`;
                    }
                }, 1000);
            }

            stopProgressUpdate() {
                if (this.progressInterval) {
                    clearInterval(this.progressInterval);
                    this.progressInterval = null;
                }
            }

            disconnect() {
                this.stopPolling();
                this.stopProgressUpdate();
                console.log('üéµ Spotify ÏúÑÏ†Ø Ïó∞Í≤∞ Ï¢ÖÎ£å');
            }
        }

        // ÏúÑÏ†Ø ÏãúÏûë
        const spotifyWidget = new SpotifyWidget();
    </script>
</body>
</html> 